name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Timeout de 30 minutos para builds largos

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify secrets
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ]; then exit 1; fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then exit 1; fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then exit 1; fi

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Crear directorio si no existe
            mkdir -p ~/aws-mvp-app
            cd ~/aws-mvp-app

            # Asegurar que estamos en la rama correcta
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
            else
              # Si es la primera vez, clonar (ajusta la URL del repo según corresponda)
              # git clone <REPO_URL> .
              echo "⚠️ El directorio existe pero no es un repo git. Por favor clona el repo primero en el servidor."
              exit 1
            fi

            # Ejecutar script de despliegue
            chmod +x deploy.sh
            ./deploy.sh
