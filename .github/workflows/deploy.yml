name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Verificar que los secrets est√©n configurados
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "‚ùå Error: EC2_SSH_KEY secret no est√° configurado"
            exit 1
          fi

          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "‚ùå Error: EC2_HOST secret no est√° configurado"
            exit 1
          fi

          # Escribir clave SSH
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Agregar host a known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

          echo "‚úÖ SSH configurado correctamente"

      - name: Test SSH Connection
        run: |
          echo "üîç Probando conexi√≥n SSH..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o LogLevel=DEBUG3 \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "echo '‚úÖ Conexi√≥n SSH exitosa'" || {
            echo "‚ùå Error en conexi√≥n SSH"
            echo "Verificando clave SSH..."
            ls -la ~/.ssh/deploy_key
            head -1 ~/.ssh/deploy_key
            tail -1 ~/.ssh/deploy_key
            exit 1
          }

      - name: Copy files to EC2
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'backend/node_modules' \
            --exclude 'frontend/node_modules' \
            --exclude '.env' \
            --exclude 'backend/.env.local' \
            --exclude 'backend/.env.production' \
            --exclude 'frontend/.env.local' \
            --exclude '*.log' \
            --exclude '*.pem' \
            --exclude '*.key' \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/aws-mvp-app/

      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/aws-mvp-app
            
            # Exportar variables de entorno para docker-compose
            export VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
            
            # Construir y levantar servicios
            # Usar 'docker compose' (plugin) en lugar de 'docker-compose' (standalone)
            docker compose -f docker-compose.prod.yml pull || true
            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d
            
            # Limpiar im√°genes antiguas
            docker image prune -f
            
            # Verificar que los servicios est√©n corriendo
            sleep 10
            docker compose -f docker-compose.prod.yml ps
            
            echo "‚úÖ Despliegue completado"
          EOF

      - name: Health Check
        run: |
          sleep 15
          BACKEND_URL="${{ secrets.VITE_API_BASE_URL }}/health"
          echo "Verificando health check en: $BACKEND_URL"
          curl -f $BACKEND_URL || echo "‚ö†Ô∏è Health check fall√≥, pero el despliegue continu√≥"
